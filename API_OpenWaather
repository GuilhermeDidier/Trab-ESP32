"""
Sistema de Irriga√ß√£o Inteligente - Integra√ß√£o com OpenWeather API
FIAP - Fase 2 - Agricultura Digital
"""

import requests
import json
import time
import pandas as pd
from datetime import datetime, timedelta
import serial
import matplotlib.pyplot as plt

# Configura√ß√µes da API
API_KEY = "b1a068f7daf64c487a29fa43acd081c6"  # Chave configurada
BASE_URL = "http://api.openweathermap.org/data/2.5"
CITY = "Sao Paulo"
COUNTRY_CODE = "BR"

# Configura√ß√µes do Serial (para comunica√ß√£o com ESP32)
# SERIAL_PORT = "COM3"  # Windows
# SERIAL_PORT = "/dev/ttyUSB0"  # Linux
# BAUD_RATE = 115200

class IrrigationSystem:
    def __init__(self):
        self.weather_data = []
        self.sensor_data = []
        self.irrigation_log = []
        
    def get_current_weather(self):
        """
        Obt√©m dados meteorol√≥gicos atuais da API OpenWeather
        """
        try:
            url = f"{BASE_URL}/weather"
            params = {
                "q": f"{CITY},{COUNTRY_CODE}",
                "appid": API_KEY,
                "units": "metric",
                "lang": "pt_br"
            }
            
            response = requests.get(url, params=params)
            
            if response.status_code == 200:
                data = response.json()
                
                weather_info = {
                    "timestamp": datetime.now().isoformat(),
                    "temperature": data["main"]["temp"],
                    "humidity": data["main"]["humidity"],
                    "pressure": data["main"]["pressure"],
                    "weather": data["weather"][0]["description"],
                    "wind_speed": data["wind"]["speed"],
                    "clouds": data["clouds"]["all"],
                    "rain_1h": data.get("rain", {}).get("1h", 0)
                }
                
                self.weather_data.append(weather_info)
                return weather_info
            else:
                print(f"Erro na API: {response.status_code}")
                return None
                
        except Exception as e:
            print(f"Erro ao obter dados meteorol√≥gicos: {e}")
            return None
    
    def get_forecast(self):
        """
        Obt√©m previs√£o do tempo para os pr√≥ximos 5 dias
        """
        try:
            url = f"{BASE_URL}/forecast"
            params = {
                "q": f"{CITY},{COUNTRY_CODE}",
                "appid": API_KEY,
                "units": "metric",
                "lang": "pt_br",
                "cnt": 40  # 5 dias (8 previs√µes por dia)
            }
            
            response = requests.get(url, params=params)
            
            if response.status_code == 200:
                data = response.json()
                
                forecast = []
                for item in data["list"]:
                    forecast.append({
                        "datetime": item["dt_txt"],
                        "temperature": item["main"]["temp"],
                        "humidity": item["main"]["humidity"],
                        "rain_probability": item.get("pop", 0) * 100,
                        "rain_volume": item.get("rain", {}).get("3h", 0)
                    })
                
                return forecast
            else:
                print(f"Erro na API: {response.status_code}")
                return None
                
        except Exception as e:
            print(f"Erro ao obter previs√£o: {e}")
            return None
    
    def analyze_irrigation_need(self, soil_moisture, temperature=None):
        """
        Analisa a necessidade de irriga√ß√£o com base nos dados
        
        Parameters:
        - soil_moisture: umidade do solo (%)
        - temperature: temperatura atual (¬∞C)
        """
        weather = self.get_current_weather()
        forecast = self.get_forecast()
        
        # Decis√£o de irriga√ß√£o
        irrigation_needed = False
        irrigation_duration = 0  # em minutos
        reason = []
        
        # Verificar umidade do solo
        if soil_moisture < 30:
            irrigation_needed = True
            irrigation_duration = 15
            reason.append("Solo muito seco")
        elif soil_moisture < 50:
            irrigation_needed = True
            irrigation_duration = 10
            reason.append("Solo moderadamente seco")
        
        # Verificar previs√£o de chuva nas pr√≥ximas 6 horas
        if forecast:
            rain_expected = False
            for f in forecast[:2]:  # Pr√≥ximas 6 horas
                if f["rain_volume"] > 5:  # mais de 5mm de chuva
                    rain_expected = True
                    break
            
            if rain_expected:
                irrigation_needed = False
                reason.append("Chuva prevista nas pr√≥ximas horas")
        
        # Verificar temperatura
        if weather and weather["temperature"] > 35:
            irrigation_duration += 5
            reason.append("Temperatura muito alta")
        
        # Verificar umidade do ar
        if weather and weather["humidity"] < 30:
            irrigation_duration += 3
            reason.append("Ar muito seco")
        
        decision = {
            "timestamp": datetime.now().isoformat(),
            "irrigate": irrigation_needed,
            "duration_minutes": irrigation_duration,
            "soil_moisture": soil_moisture,
            "weather_temp": weather["temperature"] if weather else None,
            "weather_humidity": weather["humidity"] if weather else None,
            "rain_last_hour": weather["rain_1h"] if weather else 0,
            "reasons": reason
        }
        
        self.irrigation_log.append(decision)
        return decision
    
    def simulate_sensor_data(self, hours=24):
        """
        Simula dados de sensores para teste
        """
        import random
        
        for i in range(hours):
            # Simular varia√ß√£o de umidade do solo
            base_moisture = 50
            moisture_variation = random.gauss(0, 15)
            soil_moisture = max(10, min(90, base_moisture + moisture_variation))
            
            # Analisar necessidade de irriga√ß√£o
            decision = self.analyze_irrigation_need(soil_moisture)
            
            print(f"\n===== Hora {i+1} =====")
            print(f"Umidade do Solo: {soil_moisture:.1f}%")
            print(f"Irriga√ß√£o: {'SIM' if decision['irrigate'] else 'N√ÉO'}")
            
            if decision['irrigate']:
                print(f"Dura√ß√£o: {decision['duration_minutes']} minutos")
                print(f"Motivos: {', '.join(decision['reasons'])}")
            
            # Simular irriga√ß√£o afetando a umidade
            if decision['irrigate']:
                soil_moisture = min(90, soil_moisture + decision['duration_minutes'] * 2)
            
            time.sleep(1)  # Delay para simula√ß√£o
    
    def export_data_to_csv(self):
        """
        Exporta dados coletados para CSV (para an√°lise em R)
        """
        # Exportar log de irriga√ß√£o
        if self.irrigation_log:
            df_irrigation = pd.DataFrame(self.irrigation_log)
            df_irrigation.to_csv("irrigation_log.csv", index=False)
            print("‚úì Dados de irriga√ß√£o exportados para irrigation_log.csv")
        
        # Exportar dados meteorol√≥gicos
        if self.weather_data:
            df_weather = pd.DataFrame(self.weather_data)
            df_weather.to_csv("weather_data.csv", index=False)
            print("‚úì Dados meteorol√≥gicos exportados para weather_data.csv")
    
    def visualize_data(self):
        """
        Cria visualiza√ß√µes dos dados coletados
        """
        if not self.irrigation_log:
            print("Sem dados para visualizar")
            return
        
        df = pd.DataFrame(self.irrigation_log)
        
        # Converter timestamp para datetime
        df['timestamp'] = pd.to_datetime(df['timestamp'])
        
        # Criar subplots
        fig, axes = plt.subplots(2, 2, figsize=(15, 10))
        
        # 1. Umidade do solo ao longo do tempo
        axes[0, 0].plot(df['timestamp'], df['soil_moisture'], 'b-', linewidth=2)
        axes[0, 0].axhline(y=30, color='r', linestyle='--', label='Limite inferior')
        axes[0, 0].axhline(y=70, color='g', linestyle='--', label='Limite superior')
        axes[0, 0].set_title('Umidade do Solo ao Longo do Tempo')
        axes[0, 0].set_xlabel('Tempo')
        axes[0, 0].set_ylabel('Umidade (%)')
        axes[0, 0].legend()
        axes[0, 0].grid(True, alpha=0.3)
        
        # 2. Dura√ß√£o da irriga√ß√£o
        irrigation_events = df[df['irrigate'] == True]
        if not irrigation_events.empty:
            axes[0, 1].bar(range(len(irrigation_events)), 
                          irrigation_events['duration_minutes'], 
                          color='blue', alpha=0.7)
            axes[0, 1].set_title('Dura√ß√£o das Irriga√ß√µes')
            axes[0, 1].set_xlabel('Evento de Irriga√ß√£o')
            axes[0, 1].set_ylabel('Dura√ß√£o (minutos)')
            axes[0, 1].grid(True, alpha=0.3)
        
        # 3. Temperatura vs Umidade do Ar
        if 'weather_temp' in df.columns:
            axes[1, 0].scatter(df['weather_temp'], df['weather_humidity'], 
                             c=df['soil_moisture'], cmap='YlGnBu', s=50)
            axes[1, 0].set_title('Temperatura vs Umidade do Ar')
            axes[1, 0].set_xlabel('Temperatura (¬∞C)')
            axes[1, 0].set_ylabel('Umidade do Ar (%)')
            cbar = plt.colorbar(axes[1, 0].collections[0], ax=axes[1, 0])
            cbar.set_label('Umidade do Solo (%)')
            axes[1, 0].grid(True, alpha=0.3)
        
        # 4. Estat√≠sticas de Irriga√ß√£o
        total_irrigations = df['irrigate'].sum()
        total_duration = df['duration_minutes'].sum()
        avg_soil_moisture = df['soil_moisture'].mean()
        
        stats_text = f"""
        Estat√≠sticas do Per√≠odo:
        
        Total de Irriga√ß√µes: {total_irrigations}
        Tempo Total de Irriga√ß√£o: {total_duration} min
        Umidade M√©dia do Solo: {avg_soil_moisture:.1f}%
        Taxa de Irriga√ß√£o: {(total_irrigations/len(df)*100):.1f}%
        """
        
        axes[1, 1].text(0.1, 0.5, stats_text, fontsize=12, 
                       verticalalignment='center',
                       bbox=dict(boxstyle='round', facecolor='lightblue', alpha=0.5))
        axes[1, 1].axis('off')
        
        plt.suptitle('Dashboard - Sistema de Irriga√ß√£o Inteligente', fontsize=16)
        plt.tight_layout()
        plt.savefig('irrigation_dashboard.png', dpi=300, bbox_inches='tight')
        plt.show()
        
        print("‚úì Dashboard salvo como irrigation_dashboard.png")

def main():
    """
    Fun√ß√£o principal
    """
    print("=" * 50)
    print("SISTEMA DE IRRIGA√á√ÉO INTELIGENTE - FIAP")
    print("Integra√ß√£o com OpenWeather API")
    print("=" * 50)
    
    # Criar inst√¢ncia do sistema
    system = IrrigationSystem()
    
    while True:
        print("\n--- MENU ---")
        print("1. Obter dados meteorol√≥gicos atuais")
        print("2. Obter previs√£o do tempo (5 dias)")
        print("3. Simular sistema (24 horas)")
        print("4. Exportar dados para CSV")
        print("5. Visualizar dashboard")
        print("6. An√°lise de irriga√ß√£o manual")
        print("0. Sair")
        
        choice = input("\nEscolha uma op√ß√£o: ")
        
        if choice == "1":
            weather = system.get_current_weather()
            if weather:
                print(f"\nüå°Ô∏è Temperatura: {weather['temperature']}¬∞C")
                print(f"üíß Umidade: {weather['humidity']}%")
                print(f"üåßÔ∏è Chuva (√∫ltima hora): {weather['rain_1h']}mm")
                print(f"üí® Vento: {weather['wind_speed']}m/s")
                print(f"‚òÅÔ∏è Nuvens: {weather['clouds']}%")
                print(f"üìù Condi√ß√£o: {weather['weather']}")
        
        elif choice == "2":
            forecast = system.get_forecast()
            if forecast:
                print("\nüìÖ PREVIS√ÉO PARA OS PR√ìXIMOS 5 DIAS:")
                for i, f in enumerate(forecast[:8]):  # Mostrar pr√≥ximas 24h
                    print(f"{f['datetime']}: {f['temperature']:.1f}¬∞C, "
                          f"Chuva: {f['rain_probability']:.0f}% ({f['rain_volume']}mm)")
        
        elif choice == "3":
            print("\nüîÑ Iniciando simula√ß√£o de 24 horas...")
            system.simulate_sensor_data(24)
        
        elif choice == "4":
            system.export_data_to_csv()
        
        elif choice == "5":
            system.visualize_data()
        
        elif choice == "6":
            try:
                moisture = float(input("Digite a umidade do solo (%): "))
                decision = system.analyze_irrigation_need(moisture)
                
                print(f"\n--- AN√ÅLISE DE IRRIGA√á√ÉO ---")
                print(f"Decis√£o: {'IRRIGAR' if decision['irrigate'] else 'N√ÉO IRRIGAR'}")
                if decision['irrigate']:
                    print(f"Dura√ß√£o recomendada: {decision['duration_minutes']} minutos")
                print(f"Motivos: {', '.join(decision['reasons'])}")
                
            except ValueError:
                print("‚ùå Valor inv√°lido!")
        
        elif choice == "0":
            print("\nüëã Encerrando sistema...")
            system.export_data_to_csv()
            break
        
        else:
            print("‚ùå Op√ß√£o inv√°lida!")

if __name__ == "__main__":
    main()
